import streamlit as st
from google import genai
import PIL.Image
import re

# 1. Initialize Client
client = genai.Client(api_key=st.secrets["GEMINI_API_KEY"])

# 2. Page Configuration
st.set_page_config(page_title="OmniHealth AI", layout="wide", page_icon="‚öïÔ∏è")

# 3. iOS "Zero-Box" Glassmorphism CSS + JavaScript üé®
st.markdown("""
    <style>
    /* üö´ HIDE DEFAULT STREAMLIT HEADER & PADDING */
    header {visibility: hidden;}
    .main .block-container {
        padding-top: 2rem;
        padding-bottom: 0rem;
    }
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}

    /* üåå Clean iOS Dark Background */
    .stApp {
        background: linear-gradient(135deg, #0f172a 0%, #020617 100%);
    }

    /* ‚ú® Smooth Cursor Glow */
    #cursor-glow {
        position: fixed;
        width: 600px;
        height: 600px;
        background: radial-gradient(circle, rgba(56, 189, 248, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        pointer-events: none;
        transform: translate(-50%, -50%);
        z-index: 1;
    }

    /* Ô£ø iOS Glassmorphism Panel (Single Container) */
    .glass-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(45px) saturate(160%);
        -webkit-backdrop-filter: blur(45px) saturate(160%);
        border-radius: 35px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 50px;
        box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.7);
        margin: 20px auto;
        color: white;
    }

    /* üîò iOS Style Wide Buttons */
    .stButton>button {
        width: 100% !important;
        white-space: nowrap !important;
        background: rgba(255, 255, 255, 0.08) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: #ffffff !important;
        border-radius: 14px !important;
        padding: 14px 20px !important;
        font-weight: 500 !important;
        transition: 0.2s ease-in-out;
    }
    
    .stButton>button:hover {
        background: rgba(255, 255, 255, 0.15) !important;
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(56, 189, 248, 0.2);
    }
    </style>

    <div id="cursor-glow"></div>

    <script>
    const glow = document.getElementById('cursor-glow');
    document.addEventListener('mousemove', (e) => {
        window.requestAnimationFrame(() => {
            glow.style.left = e.clientX + 'px';
            glow.style.top = e.clientY + 'px';
        });
    });
    </script>
    """, unsafe_allow_html=True)

# 4. State Management
if 'analysis_output' not in st.session_state:
    st.session_state.analysis_output = None

# --- MAIN UI ---
l, mid, r = st.columns([1, 10, 1])

with mid:
    # Everything sits inside this single div for the Apple look
    st.markdown('<div class="glass-card">', unsafe_allow_html=True)
    
    # Ô£ø HEADER
    h_col1, h_col2 = st.columns([4, 1.3])
    with h_col1:
        st.title("‚öïÔ∏è OmniHealth AI")
        st.caption("Context-Aware Medical Engine ‚Ä¢ Apple Glass Design")
    with h_col2:
        st.markdown("<br>", unsafe_allow_html=True)
        # Replacing info box with a simple styled status text
        st.write("üü¢ **System Active**")

    st.markdown("<br><br>", unsafe_allow_html=True)

    # Ô£ø BODY
    b_col1, b_col2 = st.columns([1.1, 1])
    
    with b_col1:
        st.subheader("Analyze Input")
        
        # Wide Horizontal Input
        i_col1, i_col2 = st.columns([4, 1.2])
        with i_col1:
            manual_name = st.text_input("Name", placeholder="Enter symptoms or product...", label_visibility="collapsed")
        with i_col2:
            lang = st.selectbox("Lang", ["English", "Hindi"], label_visibility="collapsed")
        
        uploaded_file = st.file_uploader("Upload Image", type=["jpg", "png"], label_visibility="collapsed")
        
        # Fixed Action Buttons
        btn_col1, btn_col2, _ = st.columns([2, 1, 1])
        with btn_col1:
            run = st.button("Run Advanced Analysis üîç")
        with btn_col2:
            if st.button("Reset"):
                st.session_state.analysis_output = None
                st.rerun()

    with b_col2:
        st.subheader("Medical Report")
        if st.session_state.analysis_output:
            # Custom styled report box
            st.markdown(f'<div style="background:rgba(255,255,255,0.05); padding:20px; border-radius:15px; border: 1px solid rgba(255,255,255,0.1);">{st.session_state.analysis_output}</div>', unsafe_allow_html=True)
        else:
            st.info("Awaiting input for analysis.")

    st.markdown('</div>', unsafe_allow_html=True)

st.caption("DISCLAIMER: For educational purposes only. Consult a doctor for medical advice.")
